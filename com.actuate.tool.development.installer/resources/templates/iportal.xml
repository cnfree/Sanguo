<project name="iportal" basedir="." default="test_process">
	<echo message="${ant.version}" />
	<echo message="${basedir}" />
	<property file="build.properties" />
	<target name="echo">
		<echo message="${ant.version}" />
		<echo message="${basedir}" />
		<echo message="${p4.root}/${p4.view}" />
	</target>
	
	<target name="set_p4">
		<description> 
			settings of connection to depot
		</description>
		<exec executable="p4" failonerror="true">
			<arg line="set P4PORT=${p4port} P4USER=${p4user} P4PASSWD=${p4passwd}" />
		</exec>
	</target>
	<target name="set_p4_client" depends="set_p4">
		<description> 
			open a temporary file where p4 client information recorded, Root and View should be modified accordingly
		</description>
		<exec executable="p4" failonerror="true">
			<arg line="client" />
		</exec>
	</target>
	<target name="p4_sync" depends="set_p4_client">
		<description> 
			sync code from depot to workspace
		</description>
		<exec executable="p4" failonerror="true">
			<arg line="sync ${p4.force} //${p4.view}/..." />
		</exec>
	</target>
		
	<target name="copy_build">
		<description> 
			get build file from qaant
		</description>
		<copy file="${server.path}/${ActuateBirtViewer.file}" todir="${basedir}/temp" />
	</target>
	<target name="unzip">
		<description> 
			unzip build file to temporary folder
		</description>
		<unzip src="${basedir}/temp/${ActuateBirtViewer.file}" dest="${basedir}/temp/ActuateBirtViewer" />
		<unzip src="${basedir}/temp/ActuateBirtViewer/${ActuateBIRTJavaComponent.file}" dest="${basedir}/temp/ActuateBirtViewer/${ActuateBIRTJavaComponent.dir}" />
	</target>
	<target name="deletet_jars">
		<description> 
			delete jars from p4 branch
		</description>
		<delete dir="${p4.root}/${p4.view}/WEB-INF/lib" />
	</target>
	<target name="copy_jars">
		<description> 
			copy jars from unzip build files to p4 branch
		</description>
		<copy todir="${p4.root}/${p4.view}/WEB-INF/lib">
			<fileset dir="${basedir}/temp/ActuateBirtViewer/${ActuateBIRTJavaComponent.dir}/WEB-INF/lib" />
		</copy>
		<delete file="${p4.root}/${p4.view}/WEB-INF/lib/aciportal.jar" />
	</target>
	<target name="copy_replace_files">
		<description> 
			copy and replace files
		</description>
		<mkdir dir="${p4.root}/${p4.view}/WEB-INF/platform"/>
		<copy todir="${p4.root}/${p4.view}/WEB-INF/platform">
			<fileset dir="${basedir}/temp/ActuateBirtViewer/${ActuateBIRTJavaComponent.dir}/WEB-INF/platform"/>
		</copy>
		<mkdir dir="${p4.root}/${p4.view}/WEB-INF/reportengines"/>
		<copy todir="${p4.root}/${p4.view}/WEB-INF/reportengines">
			<fileset dir="${basedir}/temp/ActuateBirtViewer/${ActuateBIRTJavaComponent.dir}/WEB-INF/reportengines"/>
		</copy>
		<mkdir dir="${p4.root}/${p4.view}/WEB-INF/repository"/>
		<copy todir="${p4.root}/${p4.view}/WEB-INF/repository">
			<fileset dir="${basedir}/temp/ActuateBirtViewer/${ActuateBIRTJavaComponent.dir}/WEB-INF/repository"/>
		</copy>
		<copy file="${basedir}/temp/ActuateBirtViewer/${ActuateBIRTJavaComponent.dir}/WEB-INF/ajclicense.xml" todir="${p4.root}/${p4.view}/WEB-INF"/>
		<copy file="${basedir}/temp/ActuateBirtViewer/${ActuateBIRTJavaComponent.dir}/WEB-INF/struts-bean.tld" todir="${p4.root}/${p4.view}/WEB-INF"/>
		<copy file="${basedir}/temp/ActuateBirtViewer/${ActuateBIRTJavaComponent.dir}/WEB-INF/struts-html.tld" todir="${p4.root}/${p4.view}/WEB-INF"/>
		<copy file="${basedir}/temp/ActuateBirtViewer/${ActuateBIRTJavaComponent.dir}/WEB-INF/struts-logic.tld" todir="${p4.root}/${p4.view}/WEB-INF"/>
		<copy file="${basedir}/temp/ActuateBirtViewer/${ActuateBIRTJavaComponent.dir}/WEB-INF/struts-nested.tld" todir="${p4.root}/${p4.view}/WEB-INF"/>
		<copy file="${basedir}/temp/ActuateBirtViewer/${ActuateBIRTJavaComponent.dir}/WEB-INF/struts-tiles.tld" todir="${p4.root}/${p4.view}/WEB-INF"/>
		
		<unzip src="${basedir}/replacefiles.zip" dest="${basedir}" />
		<copy file="${basedir}/replacefiles/portlet-api-1.0.jar" todir="${p4.root}/${p4.view}/WEB-INF/lib"/>
		<copy file="${basedir}/replacefiles/yuicompressor-2.3.4.jar" todir="${p4.root}/${p4.view}/WEB-INF/lib"/>
		<copy file="${basedir}/replacefiles/TimeZones.xml" todir="${p4.root}/${p4.view}/WEB-INF"/>
		<copy file="${basedir}/replacefiles/iportal-server-config.wsdd" todir="${p4.root}/${p4.view}/WEB-INF"/>
		<delete file="${p4.root}/${p4.view}/WEB-INF/web.xml"/>
		<copy file="${basedir}/replacefiles/web.xml" todir="${p4.root}/${p4.view}/WEB-INF"/>
		<delete file="${p4.root}/${p4.view}/WEB-INF/volumeProfile.xml"/>
		<copy file="${basedir}/replacefiles/volumeProfile.xml" todir="${p4.root}/${p4.view}/WEB-INF"/>
		<delete file="${p4.root}/${p4.view}/WEB-INF/classes/com/actuate/iportal/license/LicenseManager.java"/>
		<copy file="${basedir}/replacefiles/LicenseManager.java" todir="${p4.root}/${p4.view}/WEB-INF/classes/com/actuate/iportal/license"/>
		<delete file="${p4.root}/${p4.view}/WEB-INF/classes/com/actuate/reportcast/servlets/StartupServlet.java"/>
		<copy file="${basedir}/replacefiles/StartupServlet.java" todir="${p4.root}/${p4.view}/WEB-INF/classes/com/actuate/reportcast/servlets"/>
		<delete file="${p4.root}/${p4.view}/WEB-INF/classes/com/actuate/reportcast/servlets/FileDownloadServlet.java"/>
		<copy file="${basedir}/replacefiles/FileDownloadServlet.java" todir="${p4.root}/${p4.view}/WEB-INF/classes/com/actuate/reportcast/servlets"/>
		<delete file="${p4.root}/${p4.view}/WEB-INF/classes/com/actuate/erni/servlet/HttpServletResponseAbstractRedirector.java"/>
		<copy file="${basedir}/replacefiles/HttpServletResponseAbstractRedirector.java" todir="${p4.root}/${p4.view}/WEB-INF/classes/com/actuate/erni/servlet"/>
		
		<copy file="${basedir}/replacefiles/dashboard/shindig.properties" todir="${p4.root}/${p4.view}/WEB-INF/classes"/>
		<mkdir dir="${p4.root}/${p4.view}/WEB-INF/classes/containers/default"/>
		<copy file="${basedir}/replacefiles/dashboard/container.js" todir="${p4.root}/${p4.view}/WEB-INF/classes/containers/default"/>
		<delete file="${p4.root}/${p4.view}/dashboard/jsp/dashboardcontent.jsp"/>
		<copy file="${basedir}/replacefiles/dashboard/dashboardcontent.jsp" todir="${p4.root}/${p4.view}/dashboard/jsp"/>
		<mkdir dir="${p4.root}/${p4.view}/WEB-INF/repository/dashboard"/>
		<copy file="${basedir}/replacefiles/dashboard/empty2.dashboard" todir="${p4.root}/${p4.view}/WEB-INF/repository/dashboard"/>
		<delete file="${p4.root}/${p4.view}/.classpath"/>
		<copy file="${basedir}/replacefiles/.classpath" todir="${p4.root}/${p4.view}"/>
		<delete dir="${basedir}/replacefiles" />
	</target>
	
	<target name="test_process" depends="p4_sync">
		<description> 
			integration of above targets 
		</description>
		<copy file="${server.path}/${ActuateBirtViewer.file}" todir="${basedir}/temp" />
		<unzip src="${basedir}/temp/${ActuateBirtViewer.file}" dest="${basedir}/temp/ActuateBirtViewer" />
		<unzip src="${basedir}/temp/ActuateBirtViewer/${ActuateBIRTJavaComponent.file}" dest="${basedir}/temp/ActuateBirtViewer/${ActuateBIRTJavaComponent.dir}" />
		
		<delete dir="${p4.root}/${p4.view}/WEB-INF/lib" />
		<copy todir="${p4.root}/${p4.view}/WEB-INF/lib">
			<fileset dir="${basedir}/temp/ActuateBirtViewer/${ActuateBIRTJavaComponent.dir}/WEB-INF/lib" />
		</copy>
		<delete file="${p4.root}/${p4.view}/WEB-INF/lib/aciportal.jar" />
		
		<mkdir dir="${p4.root}/${p4.view}/WEB-INF/platform"/>
		<copy todir="${p4.root}/${p4.view}/WEB-INF/platform">
			<fileset dir="${basedir}/temp/ActuateBirtViewer/${ActuateBIRTJavaComponent.dir}/WEB-INF/platform"/>
		</copy>
		<mkdir dir="${p4.root}/${p4.view}/WEB-INF/reportengines"/>
		<copy todir="${p4.root}/${p4.view}/WEB-INF/reportengines">
			<fileset dir="${basedir}/temp/ActuateBirtViewer/${ActuateBIRTJavaComponent.dir}/WEB-INF/reportengines"/>
		</copy>
		<mkdir dir="${p4.root}/${p4.view}/WEB-INF/repository"/>
		<copy todir="${p4.root}/${p4.view}/WEB-INF/repository">
			<fileset dir="${basedir}/temp/ActuateBirtViewer/${ActuateBIRTJavaComponent.dir}/WEB-INF/repository"/>
		</copy>
		<copy file="${basedir}/temp/ActuateBirtViewer/${ActuateBIRTJavaComponent.dir}/WEB-INF/ajclicense.xml" todir="${p4.root}/${p4.view}/WEB-INF"/>
		<copy file="${basedir}/temp/ActuateBirtViewer/${ActuateBIRTJavaComponent.dir}/WEB-INF/struts-bean.tld" todir="${p4.root}/${p4.view}/WEB-INF"/>
		<copy file="${basedir}/temp/ActuateBirtViewer/${ActuateBIRTJavaComponent.dir}/WEB-INF/struts-html.tld" todir="${p4.root}/${p4.view}/WEB-INF"/>
		<copy file="${basedir}/temp/ActuateBirtViewer/${ActuateBIRTJavaComponent.dir}/WEB-INF/struts-logic.tld" todir="${p4.root}/${p4.view}/WEB-INF"/>
		<copy file="${basedir}/temp/ActuateBirtViewer/${ActuateBIRTJavaComponent.dir}/WEB-INF/struts-nested.tld" todir="${p4.root}/${p4.view}/WEB-INF"/>
		<copy file="${basedir}/temp/ActuateBirtViewer/${ActuateBIRTJavaComponent.dir}/WEB-INF/struts-tiles.tld" todir="${p4.root}/${p4.view}/WEB-INF"/>
		
		<unzip src="${basedir}/replacefiles.zip" dest="${basedir}" />
		<copy file="${basedir}/replacefiles/portlet-api-1.0.jar" todir="${p4.root}/${p4.view}/WEB-INF/lib"/>
		<copy file="${basedir}/replacefiles/yuicompressor-2.3.4.jar" todir="${p4.root}/${p4.view}/WEB-INF/lib"/>
		<copy file="${basedir}/replacefiles/TimeZones.xml" todir="${p4.root}/${p4.view}/WEB-INF"/>
		<copy file="${basedir}/replacefiles/iportal-server-config.wsdd" todir="${p4.root}/${p4.view}/WEB-INF"/>
		<delete file="${p4.root}/${p4.view}/WEB-INF/web.xml"/>
		<copy file="${basedir}/replacefiles/web.xml" todir="${p4.root}/${p4.view}/WEB-INF"/>
		<delete file="${p4.root}/${p4.view}/WEB-INF/volumeProfile.xml"/>
		<copy file="${basedir}/replacefiles/volumeProfile.xml" todir="${p4.root}/${p4.view}/WEB-INF"/>
		<delete file="${p4.root}/${p4.view}/WEB-INF/classes/com/actuate/iportal/license/LicenseManager.java"/>
		<copy file="${basedir}/replacefiles/LicenseManager.java" todir="${p4.root}/${p4.view}/WEB-INF/classes/com/actuate/iportal/license"/>
		<delete file="${p4.root}/${p4.view}/WEB-INF/classes/com/actuate/reportcast/servlets/StartupServlet.java"/>
		<copy file="${basedir}/replacefiles/StartupServlet.java" todir="${p4.root}/${p4.view}/WEB-INF/classes/com/actuate/reportcast/servlets"/>
		<delete file="${p4.root}/${p4.view}/WEB-INF/classes/com/actuate/reportcast/servlets/FileDownloadServlet.java"/>
		<copy file="${basedir}/replacefiles/FileDownloadServlet.java" todir="${p4.root}/${p4.view}/WEB-INF/classes/com/actuate/reportcast/servlets"/>
		<delete file="${p4.root}/${p4.view}/WEB-INF/classes/com/actuate/erni/servlet/HttpServletResponseAbstractRedirector.java"/>
		<copy file="${basedir}/replacefiles/HttpServletResponseAbstractRedirector.java" todir="${p4.root}/${p4.view}/WEB-INF/classes/com/actuate/erni/servlet"/>
		
		<copy file="${basedir}/replacefiles/dashboard/shindig.properties" todir="${p4.root}/${p4.view}/WEB-INF/classes"/>
		<mkdir dir="${p4.root}/${p4.view}/WEB-INF/classes/containers/default"/>
		<copy file="${basedir}/replacefiles/dashboard/container.js" todir="${p4.root}/${p4.view}/WEB-INF/classes/containers/default"/>
		<delete file="${p4.root}/${p4.view}/dashboard/jsp/dashboardcontent.jsp"/>
		<copy file="${basedir}/replacefiles/dashboard/dashboardcontent.jsp" todir="${p4.root}/${p4.view}/dashboard/jsp"/>
		<mkdir dir="${p4.root}/${p4.view}/WEB-INF/repository/dashboard"/>
		<copy file="${basedir}/replacefiles/dashboard/empty2.dashboard" todir="${p4.root}/${p4.view}/WEB-INF/repository/dashboard"/>
		<delete file="${p4.root}/${p4.view}/.classpath"/>
		<copy file="${basedir}/replacefiles/.classpath" todir="${p4.root}/${p4.view}"/>
		
		<delete dir="${basedir}/replacefiles" />
		<delete dir="${basedir}/temp" />
	</target>
</project>